---
title: "Models"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

clim <- read.csv("YCOM_2019_Data.csv")
us_cov <- read.csv("us_covid.csv")
state <- read.csv("state_data.csv")
```

```{r climate_score}
#library(tidyverse)
library(dplyr)


clim[10,3]<- "District Of Columbia"
score_func<- function(region){
  dat<-clim %>%
    filter(GeoName == region) %>%
    select(human,consensus,worried,futuregen,personal,harmUS) 
  
  rowSums(dat, na.rm = FALSE) / 6
}

state<- state %>%
  mutate(score=0)

  stat<-state[1,1]
stat
for(i in 1:51){
  stat<-state[i,1]
  s<-score_func(stat)
  state[i,77]<-s
}

scores <- state %>%
  select(State, score)

new_state <- merge(state, scores, by="State")
```


{r ignore this for now}
us_covid<- us_cov %>%
  slice(-(1:158)) %>%
  mutate(score)

n<-dim(us_covid)
n<-n/2
n<-n/2
for(i in 1:n){
  stat<-toString(us_covid[i,4])
    s<-score_func(stat)
  us_covid[i,15]<-s
}

us_covid %>%
  select(score)


```{r model}
library(broom)

modall <- lm(score.y ~ grocery_and_pharmacy_percent_change_from_baseline + retail_and_recreation_percent_change_from_baseline + parks_percent_change_from_baseline +  transit_stations_percent_change_from_baseline + (grocery_and_pharmacy_percent_change_from_baseline * retail_and_recreation_percent_change_from_baseline) + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline + status_of_reopening + stay_at_home_order + mandatory_quarantine_for_travelers + non_essential_business_closures + large_gatherings_ban + restaurant_limits + bar_closures + face_covering_requirement + primary_election_postponement + TotalPop, na.action=na.omit, data = new_state)

tidy(modall)
```

```{r assumptions, message = F, warning = F}
modall_res <- augment(modall)

ggplot(data = modall_res, mapping = aes(x = .std.resid)) + 
  geom_histogram(binwidth = 1) + 
  labs(x = "Residuals", y = "Count",
       title = "Residuals are...")

ggplot(data = modall_res, mapping = aes(x = .fitted, y = .std.resid)) + 
  geom_point() + labs(x = "Fitted Values", y = "Residuals", 
                      title = "Variance is...")
```

```{r predictive accuracy, message = F, warning = F}
#create training and test sets
set.seed(100)
training.samples <- new_new_state$score.y %>%
  createDataPartition(p = 0.8, list = FALSE)
train.data  <- new_new_state[training.samples, ]
test.data <- new_new_state[-training.samples, ]

#fit model to training set
lm_model <- lm(score.y ~ grocery_and_pharmacy_percent_change_from_baseline + retail_and_recreation_percent_change_from_baseline + parks_percent_change_from_baseline +  transit_stations_percent_change_from_baseline + (grocery_and_pharmacy_percent_change_from_baseline * retail_and_recreation_percent_change_from_baseline) + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline + status_of_reopening + bar_closures + TotalPop, na.action=na.omit, data = train.data)

predictions <- lm_model %>% predict(test.data)

#Prediction error, RMSE
RMSE(predictions, test.data$score.y)
#R-square
R2(predictions, test.data$score.y)
```
  
```{diagnosing collinearity}
#doesnt work
ols_vif_tol(modall)
```

```{r other models, message = F, warning = F}
state1 <- state%>%
  filter(stay_at_home_order!= "NA")

#some possibly interesting individual predictors that appear significant
mod1<- lm(score ~ stay_at_home_order, data=state1)

mod2 <- lm(score ~ as.factor(mandatory_quarantine_for_travelers), data=state)

mod3 <- lm(score ~ as.factor(bar_closures), data=state)

tidy(mod2)
glance(mod2)
tidy(mod1)
glance(mod1)
tidy(mod3)
glance(mod3)
```

