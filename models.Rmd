---
title: "Stat 198 Project"
author: "Anabella Buckvar, Chandler Naylon, William Reynolds, Natalie Wong"
date: "Due: Wednesday, July 29, 2020 at 11:59p"
output: pdf_document
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(broom)
library(caret)
library(sf)
```


```{r datasets, include=FALSE, echo = FALSE}
#YCOM climate data
clim <- read.csv("data/YCOM_2019_Data.csv")

#modified Google dataset containing only US entries, no global
global_covid <- read.csv(file = 'Global_Mobility_Report.csv')
us_covid <- global_covid %>%
  filter(country_region_code == "US")

#combines YCOM climate data and COVID data from above datasets by state (combined in Excel)
state <- read.csv("data/state_data.csv")

#societal COVID predictors dataset
social_distancing <- read.csv(file = 'data/State Social Distancing Actions.csv')

#dataset combining climate variables, climate scores, and COVID factors by state
new_state <- read.csv('data/new_state.csv')

#new_state except with no NAs
new_new_state <- read.csv('data/new_new_state.csv')
```


```{r climate score, echo = FALSE}
clim[10,3]<- "District Of Columbia"
score_func<- function(region){
  dat<-clim %>%
    filter(GeoName == region) %>%
    select(human,consensus,worried,futuregen,personal,harmUS) 
  
  rowSums(dat, na.rm = FALSE) / 6
}

state<- state %>%
  mutate(score=0)

  stat<-state[1,1]
stat
for(i in 1:51){
  stat<-state[i,1]
  s<-score_func(stat)
  state[i,77]<-s
}

scores <- state %>%
  select(State, score)

new_state <- merge(state, scores, by="State")
```


```{r model & predictive accuracy, message = F, warning = F, echo = FALSE}
#create training and test sets
set.seed(100)
training.samples <- new_new_state$score.y %>%
  createDataPartition(p = 0.8, list = FALSE)
train.data  <- new_new_state[training.samples, ]
test.data <- new_new_state[-training.samples, ]

#final model, fit to training set
lm_model <- lm(score.y ~ transit_stations_percent_change_from_baseline + bar_closures + retail_and_recreation_percent_change_from_baseline + parks_percent_change_from_baseline, na.action=na.omit, data = train.data)

tidy(lm_model)

summary(lm_model)

predictions <- lm_model %>% predict(test.data)

#Prediction error: RMSE
RMSE(predictions, test.data$score.y)
```


```{r detect collinearity, message = F, warning = F, echo = FALSE}
#GVIF above ~6 should be removed from the model
car::vif(lm_model)
```


```{r linear assumptions, message = F, warning = F, echo = FALSE}
lm_model_res <- augment(lm_model)

ggplot(data = lm_model_res, mapping = aes(x = .std.resid)) + 
  geom_histogram(binwidth = 1) + 
  labs(x = "Residuals", y = "Count",
       title = "Residuals are Roughly Normally Distributed")

ggplot(data = lm_model_res, mapping = aes(x = .fitted, y = .std.resid)) + 
  geom_point() + labs(x = "Fitted Values", y = "Residuals", 
                      title = "Variance Appears to be Homogenous")
```


```{r visualizations, echo = FALSE}
#sample visualizations
library(ggplot2)
library(maps)
library(mapdata)
library(tidyverse)
library(sf)
usa <- map_data("usa")
state <- read.csv("data/state_data.csv")
state <- state %>%

mutate(bar_closures)



state %>% 
  filter(BIR74 > 10000) %>% 
  select(NAME, BIR74) %>% 
  st_drop_geometry()
nc <- nc %>%
  mutate(avesids79 = SID79 / BIR79)

ggplot(nc) +
  geom_sf(aes(fill = avesids79)) +
  scale_fill_gradient(low = "#fee8c8", high ="#7f0000") +
  theme_bw()


#retail and recreation percent change in baseline


usa <- map_data("usa")
ggplot(data = state) + 
   geom_sf(aes(fill = bar_closure)) +
  theme_bw()

```
ggplot(data = usa) +
  geom_sf(color = "purple", fill = "lightblue") +
  theme_bw()


ggplot(data = usa) +
  geom_sf(aes(fill = group)) +
  scale_fill_gradient(low = "#fee8c8", high ="#7f0000") +
  theme_bw()
```{r, echo = FALSE}
library(usmap)
library(ggplot2)
state <- read.csv("data/state_data.csv")
plot_usmap(data = state, values = "bar_closures", color = "red") + 
  scale_fill_continuous(name = "Population (2015)", label = scales::comma) + 
  theme(legend.position = "right")
```
  
```{r, echo = FALSE}
state <- read.csv("data/state_data.csv")
usa <- map_data("usa")
ggplot(data = state) + 
   geom_sf(aes(fill = "bar_closure")) +
  theme_bw()

```

```{r, echo = FALSE}
new_new_state <- read.csv('data/new_new_state.csv')
var1 <- new_new_state %>% 
  select(retail_and_recreation_percent_change_from_baseline) %>%
  pull() 

states <- states %>%
  mutate(rec = var1)
usa <- map_data("usa")
ggplot(data = states) + 
   geom_sf(aes(fill = retail_recreation_percent_change_from_baseline)) +
  theme_bw()

```

```{r, echo = FALSE}
usa <- map_data("usa")
ggplot(data = state) + 
   geom_sf(aes(fill =)) +
  theme_bw()
```

```{r, echo = FALSE}
library(ggeffects)
lm_model <- lm(score.y ~ transit_stations_percent_change_from_baseline + bar_closures + retail_and_recreation_percent_change_from_baseline + parks_percent_change_from_baseline, na.action=na.omit, data = train.data)
predict3d::ggPredict(lm_model)
```

